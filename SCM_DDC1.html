<!DOCTYPE html>
<html>
<script src='./util/messagingUtil.js'></script>
<script>
	require('dotenv').config()
	apiKey = process.env.API_KEY
	console.log(apiKey);
</script>

<head>
	<title>Smart Contracts Management</title>
	<style>
		body {
			background-color: #f8f9fa;
			font-family: Arial, sans-serif;
			margin: 0;
			padding: 0;
		}

		.container {
			background-color: #fff;
			border-radius: 8px;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
			max-width: 800px;
			margin: 50px auto;
			overflow: hidden;
			/* Ensures the container wraps around floated elements */
		}

		.tabs {
			border-bottom: 2px solid #0056b3;
			display: flex;
		}

		.tab-button {
			background-color: #f8f9fa;
			border: none;
			border-bottom: 2px solid transparent;
			/* Initially transparent */
			border-radius: 4px 4px 0 0;
			cursor: pointer;
			flex: 1;
			/* Equal width for all tab buttons */
			padding: 15px 20px;
			text-align: center;
			transition: border-bottom-color 0.3s ease;
		}

		.tab-button.active {
			border-bottom-color: #0056b3;
			/* Blue border for active tab */
			color: #0056b3;
			/* Blue text for active tab */
		}

		.tab-content {
			/*SYF	display: none;*/
			display: none;
			padding: 20px;
			border: 1px solid #ccc;
			border-top: none;
			border-radius: 0 0 4px 4px;
		}

		.tab-content.active {
			display: block;
		}

		.btn-primary {
			background-color: #007bff;
			border: none;
			border-radius: 4px;
			color: #fff;
			cursor: pointer;
			padding: 10px 20px;
			transition: background-color 0.3s ease;
		}

		/*.btn-primary:hover {}*/

		.input-container {
			margin-bottom: 10px;
			/* Add margin */
		}

		/* Added style for the API response box */
		.api-response-box {
			background-color: #f0f0f0;
			border: 1px solid #ccc;
			border-radius: 4px;
			padding: 10px;
			margin-top: 20px;
			text-align: justify;
		}

		.summary-type-container {
			display: flex;
			align-items: center;
		}

		.summary-type-container label {
			margin-right: 10px;
		}

		select {
			padding: 8px;
			border-radius: 4px;
			border: 1px solid #ccc;
			font-size: 14px;
			font-family: Arial, sans-serif;
			margin-right: 10px;
			/* Adjust spacing */
		}
	</style>
</head>

<body>

	<div class="container">
		<!--<h2 style="text-align: center;">Smart Contracts Management</h2>-->

		<div class="tabs">
			<button class="tab-button active" onclick="openTab('summary')">Summary</button>
			<button class="tab-button" onclick="openTab('qa')">Q&A</button>
			<button class="tab-button" onclick="openTab('EntityExtraction')">Entity Extraction</button>
		</div>

		<div id="summary" class="tab-content active">
			<div class="summary-type-container">
				<label for="summaryTypeSelect">Choose the type of contracts:</label>
				<select id="summaryTypeSelect">
					<option value="Master Agreement">Master Agreement</option>
					<option value="Hosted Management">Hosted Management</option>
					<option value="Order Form">Order Form</option>
				</select>
			</div>

			<div class="summary-type-container">
				<label for="summaryInfoSelect">Choose the information needed:</label>
				<select id="summaryInfoSelect">
					<option value="Contract's Metadata">Contract's Metadata</option>
					<option value="Paiement Terms">Paiement terms</option>
					<option value="Limitation of Liability">Limitation of Liability</option>
				</select>
			</div>

			<button type="submit" class="btn-primary" id="callApiButton">Analyze</button>
			<p>Analysis:</p>

			<div class="api-response-box">
				<p><span id="apiResponse"></span></p>
			</div>

			<p><span id="test"></span></p>
		</div>

		<div id="qa" class="tab-content">
			<label for="textInput" class="form-label">Enter your question about the Contracts database :</label>
			<textarea class="form-input" id="textInput" rows="5" style="width: calc(100% - 20px); /* Subtract padding */ 
															padding: 10px; border-radius: 8px; border: 1px solid #ccc; 																
															background-color: #f8f9fa; font-family: Arial, sans-serif; 
															resize: vertical;"></textarea>
			<button type="submit" class="btn-primary" id="callApiButtonQa">Submit the question</button>
			<p>Answer:</p>

			<div class="api-response-box">
				<p><span id="apiResponseQ&A"></span></p>
			</div>
		</div>

		<div id="EntityExtraction" class="tab-content">
			<div class="summary-type-container">
				<label for="summaryTypeSelect">Choose the contract file:</label>
				<select id="summaryTypeSelect">
					<option value="Master Agreement">Master Agreement A</option>
					<option value="Master Agreement">Master Agreement B</option>
				</select>
			</div>
			<button type="submit" class="btn-primary" id="callApiButtonEntity">Extract the Metadata</button>
			<div class="api-response-box">
				<p><span id="checkedEntities"></span></p>
			</div>
			<!--
			<p hidden>
			<pre id="checkedEntities"></pre>
			</p>-->
		</div>
	</div>

	</div>

	<p hidden><span id="api_key"></span> </p>

	<script>

		"use strict";

		function openTab(tabName) {
			const tabs = document.querySelectorAll('.tab-button');
			tabs.forEach(tab => tab.classList.remove('active'));
			const contents = document.querySelectorAll('.tab-content');
			contents.forEach(content => content.classList.remove('active'));

			document.getElementById(tabName).classList.add('active');
			event.currentTarget.classList.add('active');
		}

		va.messagingUtil.setOnDataReceivedCallback(onDataReceived);

		/* Defined the callback function called whenever there is a new message sent from VA */
		function onDataReceived(vaMsgObj) {
			console.log(vaMsgObj.data[0][0]);
			if (vaMsgObj && vaMsgObj.data && vaMsgObj.data.length > 0) {
				document.getElementById("api_key").textContent = vaMsgObj.data[0][0];
			}
		}

		document.getElementById("callApiButton").addEventListener("click", function () {

			var contractType = document.getElementById("summaryTypeSelect").value;
			var contractInfo = document.getElementById("summaryInfoSelect").value;
			document.getElementById("apiResponse").innerHTML = "You asked for the '<strong>" + contractInfo + "</strong>' for the contracts of type <strong>'" + contractType + "'</strong>. <br>Let me see what I can get for you.";
		});

		document.getElementById("callApiButtonQa").addEventListener("click", function () {

			// apiKey is filled from the Data-Driven Content;
			const apiKey = document.getElementById("api_key").textContent;
			if (!apiKey) {

				console.error("API Key is empty");
				document.getElementById("apiResponseQ&A").textContent = "Error: API key is empty";

			} else {

				// Call Azure Services
				//const endpoint = "https://frasyf-inst1.openai.azure.com";
				//const apiUrl = '${endpoint}/openai/deployments/DDC_API/chat/completions?api-version=2024-02-01';
				const apiUrl = "https://frasyf-inst1.openai.azure.com/openai/deployments/DDC_API/chat/completions?api-version=2024-02-01";

				const headers = {
					'Content-Type': 'application/json',
					'api-key': apiKey
				};

				// Retrieve the question from the textArea
				var question = document.getElementById("textInput").value;
				const dataQuestion = {
					messages: [
						{
							role: 'user',
							content: question
						}
					]
				};

				fetch(apiUrl, {
					method: 'POST',
					headers: headers,
					body: JSON.stringify(dataQuestion)
				})

					.then(response => response.json())
					.then(data =>
						document.getElementById("apiResponseQ&A").textContent = data.choices[0].message.content
					)
					.catch(error => console.error('Error:', error.message));


			} // end else empty apiKey

		});

		document.getElementById("callApiButtonEntity").addEventListener("click", function () {
			// apiKey is filled from the Data-Driven Content;
			const apiKey = document.getElementById("api_key").textContent;
			if (!apiKey) {

				console.error("API Key is empty");
				document.getElementById("checkedEntities").textContent = "Error: API key is empty";

			} else {

				// Call Azure Services
				const apiUrl = "https://frasyf-inst1.openai.azure.com/openai/deployments/DDC_API/chat/completions?api-version=2024-02-01";

				const headers = {
					'Content-Type': 'application/json',
					'api-key': apiKey
				};

				// Retrieve the question from the textArea
				var question = "Extract the company name and location from the text below.\n\nThe company name is GREEN SUPLLY and the location is 14 rue de Villiers 75017 Paris FRANCE.";
				//var question = "Extract the company name, amount of capital, RCS number and location from the text below.\n\nGREEN SUPLLY, a Société par Actions Simplifiée with a capital of 7.242.928 € and Trade Register number RCS  Melun  B  158.741.326  having  its  registered  office  located  at  14 rue de Villiers 75017 Paris FRANCE acting for the purpose of this Agreement in its own name and in the name and on behalf of its Affiliates (hereafter “Supplier” or “GREEN SUPLLY”).\nEND\n\nThe company name is GREEN SUPLLY, the amount of capital is 7.242.928 €, the RCS number is B 158.741.326 and the location is 14 rue de Villiers 75017 Paris FRANCE";
				//TODO : get file content paragraph : document.getElementById("textInput").value;
				const dataQuestion = {
					messages: [
						{
							role: 'user',
							content: question
						}
					]
				};

				fetch(apiUrl, {
					method: 'POST',
					headers: headers,
					body: JSON.stringify(dataQuestion)
				})

					.then(response => response.json())
					.then(data =>
						//document.getElementById("checkedEntities").textContent = data.choices[0].message.content
						document.getElementById("checkedEntities").textContent = "Your question: " + question + "and the answer: " + data.choices[0].message.content
					)
					.catch(error => console.error('Error:', error.message));


			} // end else empty apiKey
		});

	</script>
</body>

</html>